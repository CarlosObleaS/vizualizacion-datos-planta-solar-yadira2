{
  "ruleChain": {
    "name": "Root Rule Chain",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "additionalInfo": null
  },
  "metadata": {
    "version": 10,
    "firstNodeIndex": 6,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save Timeseries",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "layoutX": 817,
          "layoutY": 314
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Client Attributes",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "CLIENT_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": true
        },
        "additionalInfo": {
          "layoutX": 444,
          "layoutY": 188
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "layoutX": 190,
          "layoutY": 365
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log RPC from Device",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "layoutX": 454,
          "layoutY": 90
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Other",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "layoutX": 691,
          "layoutY": 177
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rpc.TbSendRPCRequestNode",
        "name": "RPC Call Request",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "timeoutInSeconds": 60
        },
        "additionalInfo": {
          "layoutX": 698,
          "layoutY": 263
        }
      },
      {
        "type": "org.thingsboard.rule.engine.profile.TbDeviceProfileNode",
        "name": "Device Profile Node",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "persistAlarmRulesState": false,
          "fetchAlarmRulesStateOnStart": false
        },
        "additionalInfo": {
          "description": "Process incoming messages from devices with the alarm rules defined in the device profile. Dispatch all incoming messages with \"Success\" relation type.",
          "layoutX": 232,
          "layoutY": 90
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Calculador de Balance Energético",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "// Recuperamos los datos de los diferentes dispositivos\r\nvar p_fv = msg.p_in || 0;         // Solar\r\nvar p_wind = msg.p_dc || 0;       // Eólico\r\nvar p_house = msg.p_load || 500;  // Consumo casa\r\n\r\n// 1. Cálculo de generación total\r\nvar p_gen = p_fv + p_wind;\r\n\r\n// 2. Cálculo de balance (Generación - Consumo)\r\nvar balance = p_gen - p_house;\r\n\r\n// 3. Lógica de la Batería e Inversor\r\nvar p_batt = 0;\r\nvar status_batt = 'IDLE';\r\n\r\nif (balance > 0) {\r\n    p_batt = balance; // Sobra energía: cargamos batería\r\n    status_batt = 'CHARGING';\r\n} else {\r\n    p_batt = balance; // Falta energía: descargamos batería (valor negativo)\r\n    status_batt = 'DISCHARGING';\r\n}\r\n\r\n// 4. Actualizamos el mensaje con los nuevos datos calculados\r\nmsg.p_total_gen = p_gen;\r\nmsg.p_balance = balance;\r\nmsg.p_batt_flow = p_batt;\r\nmsg.batt_status = status_batt;\r\n\r\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 0,
          "layoutY": 210
        }
      },
      {
        "type": "org.thingsboard.rule.engine.debug.TbMsgGeneratorNode",
        "name": "GENERADOR",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 2,
        "configuration": {
          "msgCount": 0,
          "periodInSeconds": 5,
          "scriptLang": "TBEL",
          "jsScript": "var msg = { temp: 42, humidity: 77 };\nvar metadata = { data: 40 };\nvar msgType = \"POST_TELEMETRY_REQUEST\";\n\nreturn { msg: msg, metadata: metadata, msgType: msgType };",
          "tbelScript": "var msg = { \r\n    // Fotovoltaica (FV)\r\n    \"fv_p_in\": Math.floor(Math.random() * (5000 - 4000) + 4000), \r\n    \"fv_v_in\": 240,\r\n    \r\n    // Eólico (WIND)\r\n    \"wind_p_dc\": Math.floor(Math.random() * (2000 - 500) + 500),\r\n    \r\n    // Batería (BATT)\r\n    \"batt_soc\": 75,\r\n    \"batt_p\": 1200, // Positivo es cargando\r\n    \r\n    // Red (GRID) e Inversor (INV)\r\n    \"grid_p_import\": 0,\r\n    \"inv_eff\": 96,\r\n    \r\n    // Consumo Casa (HOUSE)\r\n    \"house_p_load\": 3500 \r\n};\r\nvar metadata = { data_type: \"simulated\" };\r\nvar msgType = \"POST_TELEMETRY_REQUEST\";\r\n\r\nreturn { msg: msg, metadata: metadata, msgType: msgType };",
          "originatorId": "13814000-1dd2-11b2-8080-808080808080",
          "originatorType": "RULE_NODE"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 179,
          "layoutY": 456
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Calculos animacion",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// Calculamos el porcentaje de carga respecto al máximo (ej. 5000W)\r\nmsg.fv_ratio = msg.fv_p_in / 5000; \r\nmsg.house_ratio = msg.house_p_load / 6000;\r\n\r\n// Determinamos el color del Inversor según eficiencia\r\nmsg.inv_color = msg.inv_eff > 95 ? 'green' : (msg.inv_eff > 80 ? 'orange' : 'red');\r\n\r\nreturn {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 526,
          "layoutY": 418
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Solar",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "FV-01",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 539,
          "layoutY": 764
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Eolica",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "WIND-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 534,
          "layoutY": 703
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Casa",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "HOUSE-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 519,
          "layoutY": 478
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Inversor",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "INV-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 529,
          "layoutY": 587
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Bateria",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "BATT-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 528,
          "layoutY": 535
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Red",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "originatorSource": "ENTITY",
          "entityType": "DEVICE",
          "entityNamePattern": "GRID-01",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [],
                "negate": false
              }
            ],
            "fetchLastLevelOnly": false
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 531,
          "layoutY": 643
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 2,
        "toIndex": 0,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 2,
        "toIndex": 1,
        "type": "Post attributes"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "RPC Request from Device"
      },
      {
        "fromIndex": 2,
        "toIndex": 4,
        "type": "Other"
      },
      {
        "fromIndex": 2,
        "toIndex": 5,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 6,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 15,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 14,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 15,
        "toIndex": 0,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}